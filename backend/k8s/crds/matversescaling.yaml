apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: matversescalings.matverse.io
spec:
  group: matverse.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                # Target deployment to scale
                targetRef:
                  type: object
                  properties:
                    apiVersion:
                      type: string
                      default: "apps/v1"
                    kind:
                      type: string
                      default: "Deployment"
                    name:
                      type: string
                  required: ["name"]

                # Scaling parameters
                minReplicas:
                  type: integer
                  minimum: 1
                  default: 1
                maxReplicas:
                  type: integer
                  minimum: 1
                  default: 10

                # Decision mode
                mode:
                  type: string
                  enum: ["conservative", "balanced", "aggressive"]
                  default: "balanced"

                # Blockchain integration
                blockchain:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    contractAddress:
                      type: string
                    rpcUrl:
                      type: string
                      default: "http://localhost:8545"
                    requireApproval:
                      type: boolean
                      default: true
                    votingTimeout:
                      type: integer
                      default: 120

                # MatVerse metrics targets
                targets:
                  type: object
                  properties:
                    omegaScore:
                      type: number
                      minimum: 0
                      maximum: 1
                      default: 0.95
                    psiIndex:
                      type: number
                      minimum: 0
                      maximum: 1
                      default: 0.97
                    betaAntifragile:
                      type: number
                      minimum: 0
                      maximum: 2
                      default: 1.2
                    cpuTarget:
                      type: number
                      minimum: 0
                      maximum: 1
                      default: 0.7
                    latencyTarget:
                      type: number
                      description: "Target latency in milliseconds"
                      default: 100

              required: ["targetRef"]

            status:
              type: object
              properties:
                # Current state
                currentReplicas:
                  type: integer
                desiredReplicas:
                  type: integer

                # Last decision
                lastDecision:
                  type: object
                  properties:
                    action:
                      type: string
                    timestamp:
                      type: string
                      format: date-time
                    confidence:
                      type: number
                    reasoning:
                      type: string
                    proposalId:
                      type: integer
                    approved:
                      type: boolean

                # Metrics
                currentMetrics:
                  type: object
                  properties:
                    omegaScore:
                      type: number
                    psiIndex:
                      type: number
                    betaAntifragile:
                      type: number
                    cpuUsage:
                      type: number
                    latency:
                      type: number

                # Conditions
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string

      subresources:
        status: {}

      additionalPrinterColumns:
        - name: Target
          type: string
          jsonPath: .spec.targetRef.name
        - name: Current
          type: integer
          jsonPath: .status.currentReplicas
        - name: Desired
          type: integer
          jsonPath: .status.desiredReplicas
        - name: Last Action
          type: string
          jsonPath: .status.lastDecision.action
        - name: Omega
          type: number
          jsonPath: .status.currentMetrics.omegaScore
          format: float
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

  scope: Namespaced
  names:
    plural: matversescalings
    singular: matversescaling
    kind: MatVerseScaling
    shortNames:
      - mvs
